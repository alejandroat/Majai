<app-navbar></app-navbar>
<section class="vestidos">
	<h1>Vestidos</h1>

	<div class="toolbar">
		<button class="btn-primary" type="button" (click)="openModal()">Agregar vestido</button>
		<input
			class="search-input"
			type="text"
			placeholder="Buscar por nombre, talla o color"
			[(ngModel)]="query"
			(input)="onSearchChange()"
		/>
	</div>

	<div *ngIf="loading" class="status">Cargando inventario‚Ä¶</div>
	<div *ngIf="error && !loading" class="status error">{{ error }}</div>

	<div class="table-wrapper" *ngIf="!loading && !error">
		<table class="table">
			<thead>
				<tr>
					<th>Codigo</th>
					<th>Genero</th>
					<th>Ocasi√≥n</th>
					<th>Talla</th>
					<th>Color</th>
					<th>Precio</th>
					<th>Descripci√≥n</th>
					<th>Acciones</th>
				</tr>
			</thead>
			<tbody>
				<tr *ngFor="let row of filtered; trackBy: trackRow">
					<td>{{ row.codigo }}</td>
					<td>{{ row.genero || '-' }}</td>
					<td>{{ row.ocasion || '-' }}</td>
					<td>{{ row.talla || '-' }}</td>
					<td>{{ row.color || '-' }}</td>
					<td>{{ row.valor ? '$' + formatNumber(row.valor) : '-' }}</td>
					<td>{{ row.descripcion }}</td>
					<td>
						<button class="btn-action" type="button" (click)="verDetalle(row)">Ver detalle</button>
						<button class="btn-action" type="button" (click)="openEdit(row)">Editar</button>
						<button class="btn-action danger" type="button" (click)="deleteRow(row)">Eliminar</button>
						<button class="btn-action" type="button" (click)="generateQR(row)">QR</button>
					</td>
				</tr>
				<tr *ngIf="filtered.length === 0">
					<td colspan="8" class="empty">No hay resultados</td>
				</tr>
			</tbody>
		</table>
	</div>
</section>

<button class="fab" (click)="openScanner()">üì∑</button>

<app-qr-scanner
  *ngIf="showScanner"
  (scanned)="onScanned($event)"
  (closed)="showScanner = false"
  (error)="onScannerError($event)">
</app-qr-scanner>

<!-- Modal Crear Inventario -->
<div class="modal-backdrop" *ngIf="modalOpen">
	<div class="modal-card">
		<div class="modal-header">
			<h2>{{ modalMode === 'edit' ? 'Editar vestido' : 'Agregar vestido' }}</h2>
		</div>
		<form [formGroup]="form" (ngSubmit)="submitForm()" class="modal-form">
			<!-- Secci√≥n de imagen -->
			<div class="form-section">
				<label>Imagen del vestido</label>
				<div class="image-upload-section">
					<input 
						type="file" 
						#imageInput 
						accept="image/*" 
						(change)="onFileSelected($event)"
						hidden
					>
					
					<div class="image-preview" *ngIf="imagePreview">
						<img [src]="imagePreview" alt="Preview" class="preview-img">
						<button type="button" class="btn-remove" (click)="clearImage()">√ó</button>
					</div>
					
					<div class="current-image" *ngIf="!imagePreview && modalMode === 'edit' && selectedId">
						<img [src]="getImageUrl(selectedId)" alt="Imagen actual" class="current-img">
						<p>Imagen actual</p>
					</div>
					
					<button 
						type="button" 
						class="btn-upload" 
						(click)="openFileSelector()"
						*ngIf="!imagePreview"
					>
						{{ modalMode === 'edit' ? 'Cambiar imagen' : 'Seleccionar imagen' }}
					</button>
				</div>
			</div>

			<div class="form-grid">
				<label>
					Prefijo c√≥digo
					<select formControlName="codigoPrefijo">
						<option value="" disabled>Seleccionar prefijo</option>
						<option *ngFor="let codigo of codigos" [value]="codigo">{{ codigo }}</option>
					</select>
					<div class="field-error" *ngIf="form.get('codigoPrefijo')?.invalid && form.get('codigoPrefijo')?.touched">
						<span>Debes seleccionar un prefijo de c√≥digo</span>
					</div>
				</label>
				<label>
					N√∫mero c√≥digo
					<input type="number" formControlName="codigoNumero" placeholder="N√∫mero del c√≥digo" min="1" />
					<div class="field-error" *ngIf="form.get('codigoNumero')?.invalid && form.get('codigoNumero')?.touched">
						<span>El n√∫mero de c√≥digo es requerido</span>
					</div>
				</label>
				<label>
					Descripci√≥n
					<input type="text" formControlName="descripcion" placeholder="Descripci√≥n del vestido" />
					<div class="field-error" *ngIf="form.get('descripcion')?.invalid && form.get('descripcion')?.touched">
						<span>La descripci√≥n del vestido es requerida</span>
					</div>
				</label>
				<label>
					Valor
					<input 
						#valorInput
						type="text" 
						formControlName="valor" 
						placeholder="Valor del vestido" 
						(input)="onValueInput($event)" 
					/>
					<div class="field-error" *ngIf="form.get('valor')?.invalid && form.get('valor')?.touched">
						<span>El valor del vestido es requerido</span>
					</div>
				</label>
				<label>
					Ocaci√≥n
					<input type="text" formControlName="ocasion" placeholder="Ocaci√≥n (opcional)" />
				</label>
				<label>
					G√©nero
					<select formControlName="genero">
						<option value="" disabled>Seleccionar g√©nero</option>
						<option *ngFor="let genero of generos" [value]="genero">{{ genero }}</option>
					</select>
				</label>
				<label>
					Color
					<input type="text" formControlName="color" placeholder="Color (opcional)" />
				</label>
				<label>
					Talla
					<input type="text" formControlName="talla" placeholder="Talla (opcional)" />
				</label>
			</div>

			<div class="modal-actions">
				<button type="button" class="btn-secondary" (click)="closeModal()">Cancelar</button>
				<button type="submit" class="btn-primary" [disabled]="form.invalid || submitting">
					{{ submitting ? (modalMode === 'edit' ? 'Actualizando‚Ä¶' : 'Guardando‚Ä¶') : (modalMode === 'edit' ? 'Actualizar' : 'Guardar') }}
				</button>
			</div>
		</form>
	</div>
</div>

<!-- Confirmaci√≥n eliminar vestido -->
<app-confirm-dialog
	*ngIf="confirmOpen"
	[title]="confirmTitle"
	[message]="confirmMessage"
	[confirmText]="confirmText"
	[cancelText]="cancelText"
	(confirm)="confirmDelete()"
	(cancel)="closeConfirm()"
></app-confirm-dialog>

<!-- Notification Dialog -->
<app-notification-dialog
	*ngIf="notificationOpen"
	[type]="notificationType"
	[title]="notificationTitle"
	[message]="notificationMessage"
	[autoClose]="notificationType === 'success'"
	[autoCloseDelay]="3000"
	(close)="closeNotification()"
></app-notification-dialog>


