<app-navbar></app-navbar>
<section class="facturacion">
	<h1>Facturación</h1>

	<div class="toolbar">
		<div class="toolbar-left">
			<button 
				class="btn-pdf" 
				type="button" 
				(click)="generarPDFSeleccionados()"
				[disabled]="selectedIds.length === 0 || generatingPDF"
			>
				{{ generatingPDF ? 'Generando PDF...' : 'Generar PDF (' + selectedIds.length + ')' }}
			</button>
		</div>
		<input
			class="search-input"
			type="text"
			placeholder="Buscar por cliente, documento o vestido"
			[(ngModel)]="query"
			(input)="onSearchChange()"
		/>
	</div>

	<div *ngIf="loading" class="status">Cargando alquileres…</div>
	<div *ngIf="error && !loading" class="status error">{{ error }}</div>

	<div class="table-wrapper" *ngIf="!loading && !error">
		<table class="table">
			<thead>
				<tr>
					<th>
						<input 
							type="checkbox" 
							[checked]="isAllSelected()" 
							[indeterminate]="isIndeterminate()"
							(change)="toggleSelectAll($event)"
							class="select-checkbox"
						>
					</th>
					<th>Cliente</th>
					<th>Documento</th>
					<th>Vestido</th>
					<th>Fechas</th>
					<th>Subtotal</th>
					<th>Depósito</th>
					<th>Pagado</th>
                    <th>Pendiente</th>
					<th>Acciones</th>
				</tr>
			</thead>
			<tbody>
				<tr *ngFor="let row of filtered; trackBy: trackRow">
					<td>
						<input 
							type="checkbox" 
							[checked]="isSelected(row.id)"
							(change)="toggleSelect(row.id, $event)"
							class="select-checkbox"
						>
					</td>
					<td>{{ row.NombreCliente }}</td>
					<td>
						<div class="documento-info">
							<span class="numero">{{ row.identificacionCliente }}</span>
						</div>
					</td>
					<td>
						<div class="vestido-info">
							<span class="codigo">{{ row.inventario.codigo || 'N/A' }}</span>
						</div>
					</td>
					<td>
						<div class="fechas-info">
							<span class="fecha-inicio">{{ row.fechaInicio | date:'dd/MM/yyyy' }}</span>
							<span class="separador">al</span>
							<span class="fecha-fin">{{ row.fechaFin | date:'dd/MM/yyyy' }}</span>
						</div>
					</td>
					<td class="monto">${{ row.valor | number }}</td>
					<td class="monto">${{ row.deposito | number }}</td>
					<td class="monto">${{ getTotalPagado(row) | number }}</td>
					<td class="monto">${{ (row.valor - getTotalPagado(row)) | number }}</td>
					
					<td>
						<button class="btn-action" type="button" (click)="verDetalle(row)">Ver detalle</button>
						<button class="btn-action" type="button" (click)="editarAlquiler(row)">Editar</button>
						<button class="btn-action" type="button" (click)="registrarPago(row)">Registrar pago</button>
                        <button class="btn-action danger" type="button" (click)="eliminarAlquiler(row)">Eliminar</button>
					</td>
				</tr>
				<tr *ngIf="filtered.length === 0">
					<td colspan="10" class="empty">No hay resultados</td>
				</tr>
			</tbody>
		</table>
	</div>
</section>

<!-- Modal Registrar Pago -->
<div class="modal-backdrop" *ngIf="pagoOpen">
	<div class="modal-card">
		<div class="modal-header">
			<h2>Registrar Pago</h2>
			<p class="modal-subtitle" *ngIf="selectedAlquiler">
				Cliente: {{ selectedAlquiler.NombreCliente }} - Vestido: {{ selectedAlquiler.inventario?.codigo }}
			</p>
		</div>
		<form [formGroup]="pagoForm" (ngSubmit)="submitPago()" class="modal-form">
			<div class="form-group">
				<label for="valor">Valor del pago</label>
				<input 
					type="number" 
					id="valor"
					formControlName="valor" 
					placeholder="Ingrese el valor del pago" 
					min="1"
					step="0.01"
					class="form-input"
				/>
				<div class="error-message" *ngIf="pagoForm.get('valor')?.invalid && pagoForm.get('valor')?.touched">
					El valor es requerido y debe ser mayor a 0
				</div>
			</div>
			<div class="form-group">
				<label for="tipoPago">Tipo de pago</label>
				<select 
					id="tipoPago"
					formControlName="tipoPago" 
					class="form-input"
				>
					<option value="Efectivo">Efectivo</option>
					<option value="Bold">Bold</option>
					<option value="Transferencia">Transferencia</option>
				</select>
				<div class="error-message" *ngIf="pagoForm.get('tipoPago')?.invalid && pagoForm.get('tipoPago')?.touched">
					El tipo de pago es requerido
				</div>
			</div>
			<div class="modal-actions">
				<button type="button" class="btn-secondary" (click)="closePago()">Cancelar</button>
				<button type="submit" class="btn-primary" [disabled]="pagoForm.invalid || pagoSubmitting">
					{{ pagoSubmitting ? 'Guardando...' : 'Registrar Pago' }}
				</button>
			</div>
		</form>
	</div>
</div>

<!-- Modal Editar Alquiler -->
<div class="modal-backdrop" *ngIf="editOpen">
	<div class="modal-card modal-large">
		<div class="modal-header">
			<h2>Editar Alquiler</h2>
			<p class="modal-subtitle" *ngIf="selectedAlquilerToEdit">
				Cliente: {{ selectedAlquilerToEdit.NombreCliente }} - Vestido: {{ selectedAlquilerToEdit.inventario?.codigo }}
			</p>
			<button class="close-btn" (click)="closeEdit()">&times;</button>
		</div>
		<form [formGroup]="editForm" (ngSubmit)="submitEdit()" class="modal-form">
			<div class="form-grid">
				<div class="form-group">
					<label for="fechaInicio">Fecha de inicio</label>
					<input 
						type="date" 
						id="fechaInicio"
						formControlName="fechaInicio" 
						class="form-input"
					/>
					<div class="error-message" *ngIf="editForm.get('fechaInicio')?.invalid && editForm.get('fechaInicio')?.touched">
						La fecha de inicio es requerida
					</div>
				</div>

				<div class="form-group">
					<label for="fechaFin">Fecha de fin</label>
					<input 
						type="date" 
						id="fechaFin"
						formControlName="fechaFin" 
						class="form-input"
					/>
					<div class="error-message" *ngIf="editForm.get('fechaFin')?.invalid && editForm.get('fechaFin')?.touched">
						La fecha de fin es requerida
					</div>
				</div>

				<div class="form-group">
					<label for="nombreCliente">Nombre del cliente</label>
					<input 
						type="text" 
						id="nombreCliente"
						formControlName="nombreCliente" 
						placeholder="Nombre completo del cliente"
						class="form-input"
					/>
					<div class="error-message" *ngIf="editForm.get('nombreCliente')?.invalid && editForm.get('nombreCliente')?.touched">
						El nombre del cliente es requerido
					</div>
				</div>

				<div class="form-group">
					<label for="tipoDocumento">Tipo de documento</label>
					<select 
						id="tipoDocumento"
						formControlName="tipoDocumento" 
						class="form-input"
					>
						<option value="CC">Cédula de Ciudadanía</option>
						<option value="TI">Tarjeta de Identidad</option>
						<option value="CE">Cédula de Extranjería</option>
						<option value="PAS">Pasaporte</option>
					</select>
				</div>

				<div class="form-group">
					<label for="identificacionCliente">Número de documento</label>
					<input 
						type="text" 
						id="identificacionCliente"
						formControlName="identificacionCliente" 
						placeholder="Número de documento"
						class="form-input"
					/>
					<div class="error-message" *ngIf="editForm.get('identificacionCliente')?.invalid && editForm.get('identificacionCliente')?.touched">
						El número de documento es requerido
					</div>
				</div>

				<div class="form-group">
					<label for="telefonoCliente">Teléfono</label>
					<input 
						type="tel" 
						id="telefonoCliente"
						formControlName="telefonoCliente" 
						placeholder="Número de teléfono"
						class="form-input"
					/>
					<div class="error-message" *ngIf="editForm.get('telefonoCliente')?.invalid && editForm.get('telefonoCliente')?.touched">
						El teléfono es requerido
					</div>
				</div>

				<div class="form-group">
					<label for="direccionCliente">Dirección</label>
					<input 
						type="text" 
						id="direccionCliente"
						formControlName="direccionCliente" 
						placeholder="Dirección del cliente"
						class="form-input"
					/>
				</div>

				<div class="form-group">
					<label for="deposito">Depósito</label>
					<input 
						type="number" 
						id="deposito"
						formControlName="deposito" 
						placeholder="Valor del depósito"
						min="0"
						step="1000"
						class="form-input"
					/>
				</div>

				<div class="form-group">
					<label for="valor">Valor del alquiler</label>
					<input 
						type="number" 
						id="valor"
						formControlName="valor" 
						placeholder="Valor del alquiler"
						min="1"
						step="1000"
						class="form-input"
					/>
					<div class="error-message" *ngIf="editForm.get('valor')?.invalid && editForm.get('valor')?.touched">
						El valor del alquiler es requerido
					</div>
				</div>

				<div class="form-group">
					<label for="tipoPago">Tipo de pago</label>
					<select 
						id="tipoPago"
						formControlName="tipoPago" 
						class="form-input"
					>
						<option value="CONTADO">Contado</option>
						<option value="CREDITO">Crédito</option>
						<option value="ABONO">Abono</option>
					</select>
				</div>

				<div class="form-group">
					<label for="montoPagado">Monto pagado</label>
					<input 
						type="number" 
						id="montoPagado"
						formControlName="montoPagado" 
						placeholder="Monto ya pagado"
						min="0"
						step="1000"
						class="form-input"
					/>
				</div>
			</div>

			<div class="form-group full-width">
				<label for="observaciones">Observaciones</label>
				<textarea 
					id="observaciones"
					formControlName="observaciones" 
					placeholder="Observaciones adicionales (opcional)"
					rows="3"
					class="form-input"
				></textarea>
			</div>

			<div class="modal-actions">
				<button type="button" class="btn-secondary" (click)="closeEdit()">Cancelar</button>
				<button type="submit" class="btn-primary" [disabled]="editForm.invalid || editSubmitting">
					{{ editSubmitting ? 'Actualizando...' : 'Actualizar Alquiler' }}
				</button>
			</div>
		</form>
	</div>
</div>

<!-- Modal Detalles de Abonos -->
<div class="modal-backdrop" *ngIf="detalleOpen">
	<div class="modal-card modal-large">
		<div class="modal-header">
			<h2>Detalles de Pagos</h2>
			<p class="modal-subtitle" *ngIf="selectedAlquilerDetalle">
				Cliente: {{ selectedAlquilerDetalle.NombreCliente }} - Vestido: {{ selectedAlquilerDetalle.inventario?.codigo }}
			</p>
			<button class="close-btn" (click)="closeDetalle()">&times;</button>
		</div>
		<div class="modal-body">
			<div *ngIf="loadingAbonos" class="loading-message">Cargando pagos...</div>
			
			<div *ngIf="!loadingAbonos && abonos.length === 0" class="empty-message">
				No hay pagos registrados para este alquiler
			</div>
			
			<div *ngIf="!loadingAbonos && abonos.length > 0" class="abonos-table-wrapper">
				<table class="abonos-table">
					<thead>
						<tr>
							<th>Fecha</th>
							<th>Valor</th>
							<th>Usuario</th>
						</tr>
					</thead>
					<tbody>
						<tr *ngFor="let abono of abonos; trackBy: trackAbono; let i = index">
							<td>{{ abono.fecha | date:'dd/MM/yyyy' }}</td>
							<td class="monto">${{ abono.valor | number }}</td>
							<td>{{ abono.usuario?.name || abono.Usuario?.nombre || 'N/A' }}</td>
						</tr>
					</tbody>
				</table>
			</div>
		</div>
		<div class="modal-actions">
			<button type="button" class="btn-secondary" (click)="closeDetalle()">Cerrar</button>
		</div>
	</div>
</div>

<!-- Confirm Dialog -->
<app-confirm-dialog
	*ngIf="confirmOpen"
	[title]="confirmTitle"
	[message]="confirmMessage"
	[confirmText]="confirmText"
	[cancelText]="cancelText"
	(confirm)="confirmDelete()"
	(cancel)="closeConfirm()"
></app-confirm-dialog>

<!-- Notification Dialog -->
<app-notification-dialog
	*ngIf="notificationOpen"
	[type]="notificationType"
	[title]="notificationTitle"
	[message]="notificationMessage"
	[autoClose]="notificationType === 'success'"
	[autoCloseDelay]="3000"
	(close)="closeNotification()"
></app-notification-dialog>
